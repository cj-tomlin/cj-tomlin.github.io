---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import BlogPostCard from "@/components/BlogPostCard.astro";
import ProjectCard from "@/components/ProjectCard.astro";

// Type definitions for content collections
type ProjectEntry = CollectionEntry<"projects">;
type BlogEntry = CollectionEntry<"blog">;

// Get all blog posts and projects
const allPosts = await getCollection("blog");
const allProjects = await getCollection("projects");

// Filter and sort blog posts, limit to 2 latest
const posts: BlogEntry[] = allPosts
	.filter((post: BlogEntry) => !post.data.draft)
	.sort(
		(a: BlogEntry, b: BlogEntry) =>
			b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
	)
	.slice(0, 2);

// Sort projects by date, limit to 4 latest
const projects: ProjectEntry[] = allProjects
	.sort((a: ProjectEntry, b: ProjectEntry) => {
		const dateA = a.data.date?.valueOf() ?? 0;
		const dateB = b.data.date?.valueOf() ?? 0;
		return dateB - dateA;
	})
	.slice(0, 4);

// Format date function
const formatDate = (date: Date): string => {
	return new Intl.DateTimeFormat("en-GB", {
		day: "2-digit",
		month: "2-digit",
		year: "numeric",
	}).format(date);
};
---

<Layout 
	title="CJ Tomlin - Portfolio | Software Developer"
	description="Portfolio of CJ Tomlin, a software developer showcasing projects, blog posts, and technical expertise. Explore my work in web development, programming, and technology."
	type="website"
>
	<!-- Introduction Section -->
	<section class="mb-12">
		<h1 class="text-3xl font-bold mb-4 text-primary">Chris Tomlin</h1>
		<p class="text-lg">
			Graduate of Computer Science at De Montfort University. Currently
			blogging, experimenting, and open to junior/grad roles in tech.
		</p>
	</section>

	<!-- Latest Blog Posts Section -->
	<section class="mb-16">
		<div class="flex justify-between items-center mb-4">
			<h2 class="text-2xl font-bold">
				Latest posts ({posts.length})
			</h2>
			<a href="/blog" class="text-sm text-primary hover:underline"
				>See all posts</a
			>
		</div>

		{
			posts.length === 0 ? (
				<p>No posts available yet. Check back soon!</p>
			) : (
				<div class="space-y-2">
					{posts.map((post: BlogEntry, index: number) => (
						<div class={`animate-delay-${(index + 1) * 100}`}>
							<BlogPostCard post={post} formatDate={formatDate} />
						</div>
					))}
				</div>
			)
		}
	</section>

	<!-- Projects Section -->
	<section id="projects" class="mt-16">
		<div class="flex justify-between items-center mb-4">
			<h2 class="text-2xl font-bold">Projects ({projects.length})</h2>
			<a href="/projects" class="text-sm text-primary hover:underline"
				>See all projects</a
			>
		</div>
		<div class="space-y-2">
			{
				projects.map((project: ProjectEntry, index: number) => (
					<div class={`animate-delay-${(index + 3) * 100}`}>
						<ProjectCard project={project} />
					</div>
				))
			}
		</div>
	</section>
</Layout>
